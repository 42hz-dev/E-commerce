name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - master   # master ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ì‹¤í–‰ë¨

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ PHP í™˜ê²½ ì„¤ì • (ì„ íƒ: Laravel ë“± ë¹Œë“œìš©)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, bcmath, intl, pdo_mysql

      # 3ï¸âƒ£ Composer install (vendor ë¹Œë“œ)
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # 4ï¸âƒ£ (ì„ íƒ) npm ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš° ì¶”ê°€
      # - name: Build frontend assets
      #   run: |
      #     npm ci
      #     npm run build

      # 5ï¸âƒ£ ì„œë²„ë¡œ ë°°í¬ (SCP ì‚¬ìš©)
      - name: ğŸš€ Upload project files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "./"
          target: "/var/www/e-commerce"
          overwrite: true
          # exclude: ".git,node_modules,storage,bootstrap/cache,.github"  # í•„ìš”ì‹œ ì œì™¸ ê°€ëŠ¥

      # 6ï¸âƒ£ ì„œë²„ì—ì„œ ëª…ë ¹ ì‹¤í–‰ (ì˜ˆ: ìºì‹œ ê°±ì‹ )
      - name: ğŸ”§ Run post-deploy commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/e-commerce
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
